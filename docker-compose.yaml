version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    env_file:
      - .env
    environment:
      POSTGRES_DB: ${DATABASE_NAME}
      POSTGRES_USER: ${DATABASE_USER}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      PGDATA: /var/lib/postgresql/data
    ports:
      - "${DATABASE_PORT}:5432"
    volumes:
      - ./data/postgresql/pgdata:/var/lib/postgresql/data
      - ./migrations/init.sql:/docker-entrypoint-initdb.d/001_init.sql
      - ./migrations/002_add_vhost_advanced_fields.sql:/docker-entrypoint-initdb.d/002_add_vhost_advanced_fields.sql
      - ./migrations/002_add_vhost_to_ipgroups.sql:/docker-entrypoint-initdb.d/002_add_vhost_to_ipgroups.sql
      - ./migrations/003_add_app_settings.sql:/docker-entrypoint-initdb.d/003_add_app_settings.sql
      - ./migrations/003_add_vhost_features.sql:/docker-entrypoint-initdb.d/003_add_vhost_features.sql
      - ./migrations/004_add_attack_detection_to_traffic_logs.sql:/docker-entrypoint-initdb.d/004_add_attack_detection_to_traffic_logs.sql
      - ./migrations/005_seed_default_admin.sql:/docker-entrypoint-initdb.d/005_seed_default_admin.sql
      - ./migrations/006_add_recaptcha_version.sql:/docker-entrypoint-initdb.d/006_add_recaptcha_version.sql
      - ./migrations/006_add_smtp_and_signup_settings.sql:/docker-entrypoint-initdb.d/006_add_smtp_and_signup_settings.sql
      - ./migrations/007_add_region_filtering.sql:/docker-entrypoint-initdb.d/007_add_region_filtering.sql
      - ./migrations/007_add_websocket_to_vhost_locations.sql:/docker-entrypoint-initdb.d/007_add_websocket_to_vhost_locations.sql
      - ./migrations/008_ip_groups_multiple_vhosts.sql:/docker-entrypoint-initdb.d/008_ip_groups_multiple_vhosts.sql
      - ./migrations/008_add_turnstile_settings.sql:/docker-entrypoint-initdb.d/008_add_turnstile_settings.sql
      - ./migrations/009_add_multiple_backends.sql:/docker-entrypoint-initdb.d/009_add_multiple_backends.sql
    networks:
      - waf-network

  redis:
    image: redis:7.4-alpine
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - ./data/redis:/data
    networks:
      - waf-network

  waf:
    build: .
    env_file:
      - .env
    ports:
      - "${SERVER_PORT}:${SERVER_PORT}"
      - "${SERVER_ADMIN_PORT}:${SERVER_ADMIN_PORT}"
    depends_on:
      - postgres
      - redis
    environment:
      - DATABASE_HOST=postgres
      - REDIS_HOST=redis
      - TURNSTILE_SITE_KEY=${TURNSTILE_SITE_KEY}
      - TURNSTILE_SECRET_KEY=${TURNSTILE_SECRET_KEY}
      - RECAPTCHA_SITE_KEY=${RECAPTCHA_SITE_KEY}
      - RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY}
      - RECAPTCHA_V3_SITE_KEY=${RECAPTCHA_V3_SITE_KEY}
      - RECAPTCHA_V3_SECRET_KEY=${RECAPTCHA_V3_SECRET_KEY}
      - CORS_ALLOW_ORIGIN=${CORS_ALLOW_ORIGIN:-*}
    volumes:
      - ./data/nginx/ssl:/app/ssl/certificates
      - ./data/nginx/config:/app/nginx/conf.d
      - ./data/nginx:/data/nginx  # Mount for reload signal
      - ./data/waf:/app/data
    networks:
      - waf-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80"
    depends_on:
      - waf
    networks:
      - waf-network

  # Nginx Reverse Proxy for VHosts
  nginx-proxy:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./data/nginx:/data/nginx  # Mount entire nginx data directory
      - ./data/nginx/logs:/var/log/nginx
      - ./data/nginx/ssl:/etc/nginx/ssl/certificates:ro
      - ./data/nginx/config:/etc/nginx/conf.d
      - ./data/nginx/vhost:/etc/nginx/vhost.d
    depends_on:
      - waf
    networks:
      - waf-network
    restart: unless-stopped

networks:
  waf-network:
    driver: bridge
